# 编译器设计文档

> `Sys`语言(C语言的子集) 到 `MIPS32`汇编 的编译器设计文档



## 词法分析

### Pre. 添加整型编码和分支归属

Sys语言的词法分析类别码定义如下(增加整型编码)：

<div>
  <table style="border-collapse:collapse;" width="100%">
 <tbody>
  <tr height="15.75px">
   <td valign="center" style="font-weight:700;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">单词名称</td>
   <td valign="center" style="font-weight:700;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">类别码</td>
   <td valign="center" style="font-weight:700;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">编码</td>
   <td valign="center" style="font-weight:700;font-size: 11px;width:2908px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">所属分析层</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">Ident</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">IDENFR</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">0</td>
   <td rowspan="13" colspan="1" valign="center" style="font-weight:400;font-size: 11px;width:2908px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">words</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">main</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">MAINTK</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">1</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">const</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">CONSTTK</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">2</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">int</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">INTTK</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">3</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">break</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">BREAKTK</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">4</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">continue</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">CONTINUETK</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">5</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">if</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">IFTK</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">6</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">else</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">ELSETK</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">7</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">while</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">WHILETK</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">8</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">getint</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">GETINTTK</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">9</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">printf</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">PRINTFTK</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">10</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">return</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">RETURNTK</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">11</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">void</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">VOIDTK</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">12</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">!</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">NOT</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">13</td>
   <td rowspan="23" colspan="1" valign="center" style="font-weight:400;font-size: 11px;width:2908px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">op_div</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">&amp;&amp;</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">AND</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">14</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">||</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">OR</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">15</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">+</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">PLUS</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">16</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">-</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">MINU</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">17</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">*</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">MULT</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">18</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">/</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">DIV</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">19</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">%</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">MOD</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">20</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">&lt;</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">LSS</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">21</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">&lt;=</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">LEQ</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">22</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">&gt;</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">GRE</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">23</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">&gt;=</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">GEQ</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">24</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">==</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">EQL</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">25</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">!=</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">NEQ</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">26</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">=</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">ASSIGN</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">27</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">;</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">SEMICN</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">28</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">,</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">COMMA</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">29</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">(</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">LPARENT</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">30</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">)</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">RPARENT</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">31</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">[</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">LBRACK</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">32</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">]</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">RBRACK</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">33</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">{</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">LBRACE</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">34</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">}</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">RBRACE</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">35</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">IntConst</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">INTCON</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">36</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2908px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">digit</td>
  </tr>
  <tr height="15.0px">
   <td valign="center" style="font-weight:400;font-size: 11px;width:3871px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">FormatString</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:4302px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">STRCON</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2104px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">37</td>
   <td valign="center" style="font-weight:400;font-size: 11px;width:2908px;text-align:center;color:#000000;border-top:solid #d0d7e5 1px;border-right:solid #d0d7e5 1px;border-bottom:solid #d0d7e5 1px;border-left:solid #d0d7e5 1px;">string</td>
  </tr>
 </tbody>
</table>
</div>
`所在分析层` 定义为为通过所获得的第一个字符后所选择进入的主要分支结构，如若取得的第一个字符为`[a-zA-Z_]`则进入`words`分支

分析层除了表格中列出的四种之外，还存在一个`annotation` 表示对于注释的分析，以遇到`/`字符为标志。因此`/`字符较为特殊的归入此分析层。



### 程序设计

#### 公共变量和函数

* `programCode`程序总的字符串

* `character` 当前字符
* `token` 当前字符串builder
* `tokenClass` 保存当前识别单词的类型
* `num` 存放当前读入的整型数值
* `catToken()`将当前character字符与token连接
* `reserver()` 从保留字中查找，返回标识码或`-1`(表示没找到)
* `retract()` 将读取的字符指针向后回退一个字符



#### 类定义

词法分析将每次得到的最终结果定义如下的类

```java
public class Token {
    private final String tokenClass;  // TokenClass Symbol
    private final int codeVal;        // encode value 0-37
    private final String originStr;   // original string
    private final int intValue;       // value(only `INTCON` have)
    ...
}
```



#### 字符所属类别的函数定义

对于每个字符的所属类别定义如下布尔函数

不同的类别列表如下

| 函数名    | 所含字符 |
| --------- | -------- |
| isSpace   | \s       |
| isNewLine | \n       |
| isTab     | \t       |
| isLetter  | a-zA-z   |
| isDigit   | 0-9      |
| isSemi    | ;        |
| isComma   | ,        |
| isLBrace  | {        |
| isRBrace  | }        |
| isLBrack  | [        |
| isRBrack  | ]        |
| isLParent | (        |
| isRParent | )        |
| isEqs     | =        |
| isAdd     | +        |
| isMinus   | -        |
| isStar    | *        |
| isPercent | %        |
| isLABrace | <        |
| isLABrace | >        |
| isVLine   | \|       |
| isAnd     | &        |
| isExc     | !        |
| isDiv     | /        |

在判断时，对于除`*`以外的符号，若`index >= programCode.length` 则直接返回`false`

而`*`由于用作注释的判断，会出现`while`循环的条件为`!isStar()`，因此需要进行特殊设计，在每次判断前现行判断是否越界。



## 语法分析

> 与词法分析的衔接：实验编译器采用多遍扫描的方法。词法分析的结果是一个存储了所有token的`ArrayList`。语法分析获得词法分析的结果，通过index不断读取token进行分析。



### "递归下降 + 超前看 + 回溯" 的分析方法

> 首先消除左递归支持绝大部分分析可以通过递归下降的实现，对于首字符集相同的部分，绝大部分可以通过超前看一两个终结符解决，唯一出现一个地方需要通过回溯的方式提前分析。具体设计部分分述如下：



#### 1. 消除左递归

在分析本次的语法时，首先对左递归的文法进行改写：

乘除模表达式： `MulExp → UnaryExp | MulExp ('*' | '/' | '%') UnaryExp`改写为``MulExp → MulExp {('*' | '/' | '%') MulExp}`

加减表达式 `AddExp → MulExp | AddExp ('+' | '−') MulExp` 改写为 `AddExp → MulExp {('+' | '−') MulExp}`

关系表达式 `RelExp → AddExp | RelExp ('<' | '>' | '<=' | '>=') AddExp`改写为``RelExp → AddExp { ('<' | '>' | '<=' | '>=') AddExp}``

相等性表达式 `EqExp → RelExp | EqExp ('==' | '!=') RelExp`改写为`EqExp → RelExp {('==' | '!=') RelExp}`

逻辑或表达式 `LOrExp → LAndExp | LOrExp '||' LAndExp`改写为`LOrExp → LAndExp {'||' LAndExp}`

逻辑与表达式 `LAndExp → EqExp | LAndExp '&&' EqExp`改写为``LAndExp → EqExp {'&&' EqExp}`



#### 2. 超前看

对于首字符集相同的部分， 而仅仅需要超前一两个终结符即可判断的，采用超前看的方法。

在此列出所有可以通过超前看而不必回溯的递推式及条件：

1. `编译单元 CompUnit → {Decl} {FuncDef} MainFuncDef` 通过超前看一个终结符(token)是否为`MAINTK main`，及超前看两个终结符是否为`LPARENT (` 来区分变量申明、函数定义和主函数。
2. `⼀元表达式 UnaryExp → PrimaryExp | Ident '(' [FuncRParams] ')'` 通过超前看一个终结符是否为`LPARENT (` 来区分基本表达式和函数调用。



#### 3. 回溯

本实验文法仅有一处无法通过直接的超前看区分，即

```
语句 Stmt → LVal '=' Exp ';' | LVal = 'getint''('')'';'
```

这里的两种递推方法开始处均为`LVal`，故无法通过超前看解决问题，此问题同样可以通过改写语法规则实现，但本次设计中采用回溯的方法。简单算法如下：

> 1. 保存index。
> 2. 读取一个`LVal`，并读取一个 `=`。
> 3. 查看下一个非终结符是否为`GETINTTK getint`，从而决定递推方向。
> 4. 返回到已保存的index，沿着选定的方向递推。



### ASD语法树

递归下降的分析结果产生一颗语法树，语法树的节点类的类名完全和文法的非终结符相同。建立`ASDNode`接口，使得所有节点类实现此接口。要求所有节点中实现`遍历`、`输出符合语法测试要求debug信息`、`与符号表进行链接` 、`语法语义的错误检查`等函数

节点类的继承关系如图所示：

```mermaid
graph TD;
Decl-->ConstDecl;
Decl-->VarDecl;
Def-->ConstDef;
Def-->VarDef;
BlockItem-->Decl;
BlockItem-->Stmt;
Cond-->LOrExp;
Number-->IntConst;
Exp-->AddExp;
UnaryExp-->PrimaryExp;
MulExp-->UnaryExp;
AddExp-->MulExp;
RelExp-->AddExp;
EqExp-->AddExp;
LAndExp-->EqExp;
LOrExp-->LAndExp;
ConstExp-->AddExp
```

其他类均与文法的非终结符同名，不存在继承关系，具有扁平结构。



## 符号表

采用栈式符号表的方法，遵循一块一表(全局表除外)由`<当前块的层级，当前层级的第几块> `唯一标识一张符号表。在每次进入一个块时，新建一张表(若为函数块还需要添加所有的形式变量`FuncFormVar`，每次读到变量声明则同时向表和符号栈中添加一个`SymItem`，在退出该块时，从符号栈中删除将当前符号表中的所有项。

每个符号表本身存储一个`Arraylist`，其中存有实现了`SymItem`接口的类的实例, 共有三种类实现此接口：

* `var` 所有的`int`变量和`const`常量
* `Func`所有的函数定义
* `FuncFormVar` 所有的函数形参

```mermaid
graph TD;
SymItem --> Var
SymItem --> Func
SymItem --> FuncFormVar
```

### 符号表的链接

符号表的链接是一张总的`HashMap`，用于建立抽象语法树中`Indent`标识符与`SymItem`之间的映射关系。 具体的建立步骤如下：

首先创建一张全局符号表，建立个总的栈，此后对之前建立的语法树进行一次中序遍历，期间：

> 记录当前Block层级的标识符<当前层级数，是相同层级的第几块>，确定一张全局的表记录层级的数量
>
> 1. 若遍历到了 `Block` 项， 创建一个新的符号表，当前层级数+1， 层级数量+1，绑定该符号表与层级标识符。
>2. 遍历到了 `Decl`项，首先检查栈中是否存在同名变量，存在则直接报错，否则建立SymItem项存储在栈中和当前的符号表中
> 3. 遍历到了`LVal`项，依照从栈顶到栈底的顺序进行扫描，若找到同名变量则进行注册(在`HashMap`中创建键值对)，并在层级关系中进行绑定。
> 4. 遍历到了`UnaryExp`项且属于`FuncCall`类型，依照从栈顶到栈底的顺序进行扫描，若找到同名则检查函数类型是否匹配，并在HashMap中创建键值对， 在层级关系中进行绑定。
> 5. 便利到了`FuncDef`项，将`FuncFParam`转化为符号表的`SymItem`后标记存入到
> 6. 若遍历完`Block`的子树返回，则将栈中所有当前符号表的项弹出



### 错误处理

注：加入错误处理后直接在递归下降的过程中打印语法分析的结果会有问题。

对于错误类别码为a、i、j、k的错误，归入词法或语法错误的范畴，在语法分析和词法分析阶段报出。

对于其他类别码的错误，归入语义错误的范畴，在建立符号表链接的过程中报出。

由于此部分错误的发现和记录和正常的编译程序的过程分属两个不同的控制流，因此采用异常的方式进行记录。

此外，建立一个`Recorder`类，遇到新的报错即保存下来，留待语法分析和符号表链接结束后输出。



### 符号表的扩展

* 符号表中的每个item增加一个`addr`属性，在mips代码生成时使用。
* 为了定位中间代码中，变量的某次使用对应的符号表中的项，每次在符号表中找到内容时，记录变量所对应的定义点所在的块，此后方便将变量重命名为`varName@<depth,number>`, 方便生成mips代码时对变量的地址查找。
* 添加refactor方法，将每个表中的变量重命名为`varName@<depth, number>`的形式。
* 在生成符号表时，直接将Indent与对应符号表中的item进行映射，在生成中间代码时，其中的变量名为符号表中的保证无重叠的名字而非Indent原名。



## 中间代码生成

接口实现ASDNode.mid_gen(MidCodes midcodes)多态

中间代码采用四元式的方式，即(operation, operand1, operand2，result)

本次作业中仅涉及常量声明、变量声明、读语句、写语句、赋值语句，加减乘除模除等运算语句、函数定义及调用语句， 此部分的operation定义如下：

```python
# 基本运算
OP_ASSIGN "="
OP_ADD "+"
OP_SUB "-"
OP_MUL "*"
OP_DIV "/"
OP_MOD "%"
Op_NOT "!"

# 数组运算
OP_ARR_SAVE "ARR_SAVE"
OP_ARR_LOAD "ARR_LOAD"

# IO
OP_PRINT "PRINT"
OP_GETINT "GETINT"

# 函数调用相关
OP_FUNC "FUNC"
OP_END_FUNC "END_FUNC"
OP_PREPARE_CALL "PREPARE_CALL"
OP_CALL "CALL"
OP_PUSH_PARA "PUSH_PARA"
OP_RETURN "RETURN"
Op_PUSH_PARA_ARR "PUSH_PARA_ARR"

# 跳转
Op_JUMP_IF "JUMP_IF"
Op_JUMP "JUMP"
Op_LABEL "LABEL"
```



在产生四元式时，从语法树的根节点开始调用`gen_mid`完成一次后序遍历，期间生成中间代码，为了更好地实现解耦，语法树中的节点类中添加新的中间代码时，会传递`#AUTO`参数，将由中间代码的类负责分配新的临时变量，对于操作数少于四个的指令，传递`#VACANT`占位。



## mips 代码生成

#### 初始化

数组

所有数组全部在`.data`全局段进行初始化，在准备过程中，遍历所有的符号表，找到其中的数组，确定其所需要的空间，在`.word`段进行标记。

```assembly
.data
arrName@<depth,number>: .space SPACE
```



字符常量

直接标记asczii

```assembly
.word
str_num: .asczii STRCON
```



#### 非数组变量的寻址

以函数为单位合并符号表，对每张符号表，确定新的所需空间的大小和每个变量的地址偏移。在每次进入函数前，将sp指针向下减少相同单位。在每次读取到一个中间代码的变量名时，若发现其不在寄存器中或需要写回时，查询对应的函数+全局符号表，获得相对内存的地址。



#### 数组变量寻址

直接查找所有`.data`段的数组名进行寻址。此外，数组变量的引用依然保留为`arrName[rank]@<depth, number>`的形式。将其视作普通变量，从而方便对经常出现的数组元素进行寄存器的分配。



#### 函数运行时状态的布局

变量定义(单位均为byte)：

`cal_func_sp_offset`：函数中出现的所有local变量的所需空间

`STACK_T_BEGIN`：栈中保存t寄存器的偏移量 为60

`STACK_S_BEGIN`：栈中保存s寄存器的偏移量 为24

`LOCAL_ADDR_INIT`: local变量的起始地址



函数调用时

> 1. sp 指针下移`cal_func_sp_offset + LOCAL_ADDR_INIT `的空间
> 2. 使用\$a0-\$a3传递前四个参数
> 3. 以`(sp)`为基址，传递多出的参数
> 4. 以`cal_func_sp_offset + STACK_S_BEGIN `为基址，保存所有存储在s寄存器中未写回内存的变量
> 5. jal跳转



例如对于如下的程序：

```c
int b(int a[]) {
    //now-state
    return 0;
}

int main() {
    int a[6] = {0, 0, 0, 0, 0, 0};
    b(a);
    return 0;
}
```

在运行到`now-state`处时，栈的结构如下：

<img src="stack.png" alt="stack" style="zoom: 50%;" />





#### 简单的寄存器分配

对寄存器进行简单的分配，在每次进入函数时，为按照符号表的顺序为变量分配所有的`t`寄存器和`s`寄存器，并建立绑定关系。在翻译四元式时，对于中间代码中的变量，查看其是否被分配了寄存器，若是，则直接返回此寄存器，否则用临时寄存器保存该变量在内存中的值，返回此临时寄存器。



#### 四元式的翻译

首先对于四元式中的变量，统一通过`symbol_to_addr` 或`symbol_to_addr_array`方法，将变量名转化为**寄存器或offset(\$gp\\$sp)**的形式，作为mips指令的操作数。

对于不同的中间代码的指令Op，采用不同的翻译方法。

* 基本运算

  1. 将三个操作数中的中间变量转化为变量所在的寄存器(若未分配寄存器则通过`lw`加载到临时寄存器中)。
  2. 将中间代码翻译为对应的mips指令。
  3. 结果寄存器若使用的临时寄存器则写回内存。

* IO

  1. input直接执行系统调用`li $v0, 5 - syscall`，结果赋值给变量。
  2. output若为`STRCON`，先获取位于`.data`段中的地址，再进行系统调; 若为一个`int`， 则将该变量存入`$a0`后执行系统调用。

* 函数调用相关

  1. 在`PREPARE_CALL`时，修改栈指针。
  2. 在`PUSH_PARA`时，将变量的值`PUSH_PARA`或数组的首地址`PUSH_PARA_ARR`PUSH到指定的`off($sp)`的位置。
  3. 在`CALL`时，先保存所有绑定了变量的寄存器(和`$ra`寄存器)，再通过`JAL`指令跳转到函数，此后再恢复这些寄存器。

* 跳转

  1. 将`JUMP_IF`后的条件翻译为不同的mips指令完成跳转：

     ```java
     public final HashMap<String, String> b_instr = new HashMap<String, String>() {{
     	put("!=", "bne");
     	put("==", "beq");
     	put(">=", "bge");
     	put("<=", "ble");
     	put("<", "blt");
     	put(">", "bgt");
     }};
     ```

     





